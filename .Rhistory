new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
View(variables_in_long_file)
survey_data %>% prop_grouped_survey_question(starts_with("importance_rights"))
library(tidyverse)
survey_data %>% prop_grouped_survey_question(starts_with("importance_rights"))
survey_data %>% prop_grouped_survey_question(starts_with("importance_rights"), partyid)
survey_data %>% prop_grouped_survey_question(questions = starts_with("importance_rights"), partyid)
prop_grouped_survey_question <- function(.data, questions, ...) {
quos <- rlang::enquos(...)
.data %>%
dplyr::select(..., questions, weight, sample)  %>%
tidyr::gather("question", "answer",
.dots =  -c(!!!(quos), weight, sample),
na.rm = TRUE) %>%
dplyr::group_by(questions, sample) %>%
dplyr::mutate(val = sum(val),
new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
tidyr::drop_na(..., answer) %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
survey_data %>% prop_grouped_survey_question(questions = starts_with("importance_rights"), partyid)
prop_grouped_survey_question <- function(.data, questions, ...) {
quos <- rlang::enquos(...)
.data %>%
dplyr::select(..., questions, weight, sample)  %>%
tidyr::gather("question", "answer",
.dots =  -c(!!!(quos), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
tidyr::drop_na(..., answer) %>%
dplyr::group_by(question, sample) %>%
dplyr::mutate(val = sum(val),
new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
survey_data %>% prop_grouped_survey_question(questions = starts_with("importance_rights"), partyid)
prop_grouped_survey_question <- function(.data, questions, ...) {
quos <- rlang::enquos(...)
.data %>%
dplyr::select(..., questions, weight, sample)  %>%
tidyr::gather("question", "answer",
.dots =  -c(!!!(quos), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
tidyr::drop_na(..., answer) %>%
dplyr::group_by(question, sample) %>%
dplyr::mutate(val = sum(answer),
new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
survey_data %>% prop_grouped_survey_question(questions = starts_with("importance_rights"), partyid)
prop_grouped_survey_question <- function(.data, questions, ...) {
prop_grouped_survey_question <- function(.data, questions, ...) {
quos <- rlang::enquos(...)
.data %>%
dplyr::select(..., questions, weight, sample)  %>%
tidyr::gather("question", "answer",
.dots =  -c(!!!(quos), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
tidyr::drop_na(..., answer) %>%
dplyr::group_by(question, sample) %>%
dplyr::mutate(val = sum(as.numeric(as.character(answer))),
new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
prop_grouped_survey_question <- function(.data, questions, ...) {
prop_grouped_survey_question <- function(.data, questions, ...) {
quos <- rlang::enquos(...)
.data %>%
dplyr::select(..., questions, weight, sample)  %>%
tidyr::gather("question", "answer",
.dots =  -c(!!!(quos), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
tidyr::drop_na(..., answer) %>%
dplyr::group_by(question, sample) %>%
dplyr::mutate(val = sum(as.numeric(as.character(answer))),
new_weight = val / sum(val)) %>%
dplyr::ungroup() %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = new_weight) %>%
dplyr::group_by(sample, ..., description_us,  description_au) %>%
dplyr::mutate(proportion = round(n/sum(n)*100, 0)) %>%
dplyr::select(-n) %>%
dplyr::ungroup() %>%
tidyr::unite(subgroup, c(sample, !!!(quos)), sep = "_") %>%
tidyr::spread(subgroup, proportion)
}
survey_data %>% prop_grouped_survey_question(questions = starts_with("importance_rights"), partyid)
load("~/dropboxsydneyuni/ussc Au-Us/analysis/data/survey_long_data.rdata")
View(variables_in_long_file)
dplyr::select(party_id, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(starts_with("investments_owned")), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(questions, sample) %>%
mutate(val = sum(val)) %>%
ungroup()
library(tidyverse)
df <- survey_data %>% dplyr::select(party_id, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(starts_with("investments_owned")), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(questions, sample) %>%
mutate(val = sum(val)) %>%
ungroup()
df <- survey_data %>% dplyr::select(partyid, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(starts_with("investments_owned")), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(questions, sample) %>%
mutate(val = sum(val)) %>%
ungroup()
df <- survey_data %>% dplyr::select(partyid, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(questions, sample) %>%
mutate(val = sum(val)) %>%
ungroup()
df <- survey_data %>% dplyr::select(partyid, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(answer)) %>%
ungroup()
df <- survey_data %>% dplyr::select(partyid, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(as.character(answer)))) %>%
ungroup()
View(df)
df <- survey_data %>% dplyr::select(partyid, starts_with("investments_owned"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(answer))) %>%
ungroup()
df <- survey_data %>% dplyr::select(partyid, starts_with("increased_comm"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(answer))) %>%
ungroup()
View(df)
list(unique(df$val))
df <- survey_data %>% dplyr::select(partyid, starts_with("increased_comm"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(answer))) %>%
ungroup() %>%
tidyr::drop_na(..., answer) %>%
dplyr::count(sample, ..., description_au,
description_us,
answer, wt = as.numeric(as.character(weight)))
df <- survey_data %>% dplyr::select(partyid, starts_with("increased_comm"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(answer))) %>%
ungroup() %>%
tidyr::drop_na(..., answer) %>%
dplyr::count(sample, starts_with("investments_owned"), description_au,
description_us,
answer, wt = as.numeric(as.character(weight)))
df <- survey_data %>% dplyr::select(partyid, starts_with("increased_comm"), weight, sample)  %>% tidyr::gather("question", "answer",
.dots =  -c(!!!(quos(starts_with("investments_owned"))), weight, sample),
na.rm = TRUE) %>%
dplyr::left_join(variables_in_long_file %>%
select(description_us, description_au, value),
by = c("question" = "value")) %>%
mutate(answer = factor(answer)) %>%
group_by(question, sample) %>%
mutate(val = sum(as.numeric(answer))) %>%
ungroup() %>%
tidyr::drop_na(partyid, answer) %>%
dplyr::count(sample, partyid, description_au,
description_us,
answer, wt = as.numeric(as.character(weight)))
devtools::build()
devtools::install_github('usstudiescentre/ussc', ref = "dev")
devtools::install_github('usstudiescentre/ussc',ref = 'dev')
devtools::install_github('usstudiescentre/ussc', ref = 'dev')
devtools::install_github('usstudiescentre/ussc')
ussc::ussc_pal
devtools::install_github('usstudiescentre/ussc')
ussc::ussc_pal
library(ussc)
ussc::ussc_pal
setwd("..")
devtools::build()
devtools::install_github('usstudiescentre/ussc')
ussc::ussc_pal$ussc_survey_pol
ussc::ussc_pal$ussc_survey_pol
library(ussc)
devtools::install_github('usstudiescentre/ussc')
devtools::install_github('usstudiescentre/ussc')
library(ussc)
ussc::ussc_confluence_version_history
tmp_vh <- ussc_confluence_version_history(id = "942637057")
devtools::install_github('usstudiescentre/ussc')
tmp_vh <- ussc_confluence_version_history(id = "942637057")
devtools::install_github('usstudiescentre/ussc')
devtools::install_github('usstudiescentre/ussc', force = TRUE)
ussc::ussc_confluence_version_history
library(ussc)
ussc::ussc_confluence_version_history
library(ussc)
devtools::install_github('usstudiescentre/ussc')
library(ussc)
tmp_vh <- ussc_confluence_version_history(id = "942637057")
tmp_vh <- ussc_confluence_kpi_table("950075519")
library(ussc)
devtools::install_github('usstudiescentre/ussc')
tmp_vh <- ussc_confluence_version_history(id = "942637057")
tmp_vh <- ussc_confluence_kpi_table("950075519")
View(tmp_vh)
warnings()
knitr::opts_chunk$set(echo = FALSE)
library(ussc)
library(here)
library(tidyverse)
load(here::here("climate change follow up/data/survey_long_data_2019_2020.rdata"))
priming_experiment <- function(data = survey_data_2019_2020,
var = NULL){
if(is.null(var)){
us_survey <- data %>%
filter(sample == "United States" & year == 2020) %>%
select(starts_with("travel"), article_view, weight) %>%
mutate(priming_group = case_when(
is.na(travel_plans_aus_2) ~ 1,
is.na(travel_plans_aus_1) & is.na(article_view) ~ 2,
TRUE ~ 3
))
# nest, then calculate the weighted percentage each priming group and country
priming_experiment <- us_survey %>%
group_by(priming_group) %>%
nest() %>%
mutate(data = map(data, ~.x %>%
purrr::discard(~all(is.na(.))) %>%
mutate(id = row_number()) %>%
gather(key, value, -c(weight, id)) %>%
group_by(key, value) %>%
summarise(n = sum(weight)) %>%
drop_na() %>%
mutate(prop = n / sum(n),
perc = round(prop*100,2)))) %>%
unnest(cols = c(data)) %>% # unnest the data frame, doing som string data munging, then plot
ungroup() %>%
mutate(key = str_replace(pattern = "travel_plans_", "", string = key),
key = str_replace(pattern = "(_1)|(_2)|(_3)", "", string = key),
key = str_to_upper(key),
priming_group = as.character(priming_group),
priming_group = case_when(
str_detect(priming_group, "1") ~ "Priming group: Up-front first",
str_detect(priming_group, "2") ~ "Priming group: After fire-related questions",
TRUE ~ "Priming group: after fire-related questions and NBC article",
))
return(priming_experiment)
} else {
var1 <- rlang::enquo(var)
us_survey <- data %>%
filter(sample == "United States" & year == 2020) %>%
select(var, starts_with("travel"), article_view, weight) %>%
mutate(priming_group = case_when(
is.na(travel_plans_aus_2) ~ 1,
is.na(travel_plans_aus_1) & is.na(article_view) ~ 2,
TRUE ~ 3
))
# nest, then calculate the weighted percentage each priming group and country
priming_experiment <- us_survey %>%
group_by(priming_group) %>%
nest() %>%
mutate(data = map(data, ~.x %>%
purrr::discard(~all(is.na(.))) %>%
mutate(id = row_number()) %>%
gather(key, value, -c(weight, !!var1, id)) %>%
group_by(var, key, value) %>%
summarise(n = sum(weight)) %>%
drop_na() %>%
mutate(prop = n / sum(n),
perc = round(prop*100,2)))) %>%
unnest(cols = c(data)) %>% # unnest the data frame, doing som string data munging, then plot
ungroup() %>%
mutate(key = str_replace(pattern = "travel_plans_", "", string = key),
key = str_replace(pattern = "(_1)|(_2)|(_3)", "", string = key),
key = str_to_upper(key),
priming_group = as.character(priming_group),
priming_group = case_when(
str_detect(priming_group, "1") ~ "Priming group: Up-front first",
str_detect(priming_group, "2") ~ "Priming group: After fire-related questions",
TRUE ~ "Priming group: after fire-related questions and NBC article",
))
return(priming_experiment)
}
}
us_survey1 <- us_survey %>%
select(starts_with("travel"), caseid, weight, priming_group) %>%
gather(key, value, -c(weight, caseid, priming_group)) %>%
mutate(country = str_replace(pattern = "travel_plans_", "", string = key),
country = str_replace(pattern = "(_1)|(_2)|(_3)", "", string = country),
country = str_to_upper(country),
priming_group = as.character(priming_group),
priming_group = case_when(
str_detect(priming_group, "1") ~ "Priming group: First question",
str_detect(priming_group, "2") ~ "Priming group: After fire-related questions",
TRUE ~ "Priming group: after article",
)) %>%
mutate(priming_group = factor(priming_group)) %>%
mutate(country=factor(country)) %>%
mutate(value = as.numeric(value))
us_survey <- survey_data_2019_2020 %>%
filter(sample == "United States" & year == 2020) %>%
select(starts_with("travel"), article_view, weight, caseid) %>%
mutate_at(1:6, list(~case_when(
. %in% c("Extremely likely", "Very likely") ~ 1,
. %in% c("Not at all likely", "Donâ€™t know", "Somewhat likely", "Slightly likely") ~ 0
))) %>%
mutate(priming_group = case_when(
is.na(travel_plans_aus_2) ~ 1,
is.na(travel_plans_aus_1) & is.na(article_view) ~ 2,
TRUE ~ 3
))
# nest, then calculate the weighted percentage each priming group and country
priming_experiment <- us_survey %>%
group_by(priming_group) %>%
nest() %>%
mutate(data = map(data, ~.x %>%
purrr::discard(~all(is.na(.))) %>%
mutate(id = row_number()) %>%
gather(key, value, -c(weight, id)) %>%
group_by(key, value) %>%
summarise(n = sum(weight)) %>%
drop_na() %>%
mutate(prop = n / sum(n),
perc = round(prop*100,2)))) %>%
mutate(data = map(data,  ~.x %>% mutate(value = as.character(value)))) %>%
unnest(cols = c(data)) %>% # unnest the data frame, doing som string data munging, then plot
ungroup() %>%
mutate(key = str_replace(pattern = "travel_plans_", "", string = key),
key = str_replace(pattern = "(_1)|(_2)|(_3)", "", string = key),
key = str_to_upper(key),
priming_group = as.character(priming_group),
priming_group = case_when(
str_detect(priming_group, "1") ~ "Priming group: Up-front first",
str_detect(priming_group, "2") ~ "Priming group: After fire-related questions",
TRUE ~ "Priming group: after fire-related questions and NBC article",
))
us_survey1 <- us_survey %>%
select(starts_with("travel"), caseid, weight, priming_group) %>%
gather(key, value, -c(weight, caseid, priming_group)) %>%
mutate(country = str_replace(pattern = "travel_plans_", "", string = key),
country = str_replace(pattern = "(_1)|(_2)|(_3)", "", string = country),
country = str_to_upper(country),
priming_group = as.character(priming_group),
priming_group = case_when(
str_detect(priming_group, "1") ~ "Priming group: First question",
str_detect(priming_group, "2") ~ "Priming group: After fire-related questions",
TRUE ~ "Priming group: after article",
)) %>%
mutate(priming_group = factor(priming_group)) %>%
mutate(country=factor(country)) %>%
mutate(value = as.numeric(value))
library(lme4)
m1 <- glmer(value ~ priming_group*country + (1|caseid),
weights = weight,
data = us_survey1,
verbose=1,
control=glmerControl(tolPwrss=1e-4),
family = "binomial")
summary(m1)
library(ussc)
ussc::plot_ussc_logo
remotes::install_github('usstudiescentre/ussc')
#' Append new USSC logo at the bottom of graph
#' @usage
#' plot_ussc_logo()
#' @examples
#' plot_ussc_logo(ggplot_object)
#' @author
#' Zoe Meers
#' @export
plot_ussc_logo <- function (ggplot_object){
logo <- magick::image_read_svg(system.file("USSC_convert_positive.svg", package = "ussc")) %>%
magick::image_chop("450x875+315") %>%
grid::rasterGrob(interpolate = TRUE)
logo_plot <- ggplot(mapping = aes(x = 0:1, y = 1)) + theme_void() +
annotation_custom(grob = logo, xmin = 0.85, xmax = 1.055)
gridExtra::grid.arrange(ggplot_object, logo_plot, heights = c(0.93,
0.1))
}
library(ussc)
#' Append new USSC logo at the bottom of graph
#' @usage
#' plot_ussc_logo()
#' @examples
#' plot_ussc_logo(ggplot_object)
#' @author
#' Zoe Meers
#' @export
plot_ussc_logo <- function (ggplot_object){
logo <- magick::image_read_svg(system.file("USSC_convert_positive.svg", package = "ussc")) %>%
magick::image_chop("450x875+315") %>%
grid::rasterGrob(interpolate = TRUE)
logo_plot <- ggplot(mapping = aes(x = 0:1, y = 1)) + theme_void() +
annotation_custom(grob = logo, xmin = 0.85, xmax = 1.055)
gridExtra::grid.arrange(ggplot_object, logo_plot, heights = c(0.93,
0.1))
}
