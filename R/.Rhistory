library(uss)
library(ussc)
df <- ussc_confluence_version_history(id = "942637057")
req <- httr::GET(url = glue::glue("https://usscsydney.atlassian.net/wiki/rest/api/content/942637057/version?expand=body.storage"),
httr::accept_json(), httr::authenticate(Sys.getenv("CONFLUENCE_USERNAME"), Sys.getenv("CONFLUENCE_PASSWORD")),
config <- httr::config(ssl_verifypeer = FALSE))
out <- httr::content(req)
links <- sapply(out[[1]], function(x) x$`_expandable`$content)
pub_cal_19 <- out[["results"]] %>% {
tibble::tibble(
date = purrr::map_chr(., "when"),
version_history = purrr::map_int(., "number"),
message = purrr::map_chr(., "message"),
email = as.character(purrr::map(., ~purrr::pluck(.x$by$email))),
name = as.character(purrr::map(., ~purrr::pluck(.x$by$displayName))),
link = paste0('https://usscsydney.atlassian.net/wiki', links, '&expand=body.storage')
)
}
library(tidyverse)
pub_cal_19 <- out[["results"]] %>% {
tibble::tibble(
date = purrr::map_chr(., "when"),
version_history = purrr::map_int(., "number"),
message = purrr::map_chr(., "message"),
email = as.character(purrr::map(., ~purrr::pluck(.x$by$email))),
name = as.character(purrr::map(., ~purrr::pluck(.x$by$displayName))),
link = paste0('https://usscsydney.atlassian.net/wiki', links, '&expand=body.storage')
)
}
current_version <-  httr::GET(url = glue::glue("https://usscsydney.atlassian.net/wiki/rest/api/content/{id}"),
httr::accept_json(), httr::authenticate(Sys.getenv("CONFLUENCE_USERNAME"), Sys.getenv("CONFLUENCE_PASSWORD")),
config <- httr::config(ssl_verifypeer = FALSE))
current_version <-  httr::GET(url = glue::glue("https://usscsydney.atlassian.net/wiki/rest/api/content/942637057"),
httr::accept_json(), httr::authenticate(Sys.getenv("CONFLUENCE_USERNAME"), Sys.getenv("CONFLUENCE_PASSWORD")),
config <- httr::config(ssl_verifypeer = FALSE))
current_version_content <- httr::content(current_version)
cv_tibble <- current_version_content %>% {
tibble::tibble(
date = purrr::pluck(.$version$when),
version_history = purrr::pluck(.$version$number),
message = purrr::pluck(.$version$message),
email = as.character(purrr::pluck(.$version$by$email)),
name = as.character(purrr::pluck(.$version$by$displayName)),
link = paste0(purrr::pluck(.$`_links`$self), '?expand=body.storage')
)}
pub_cal_19 <- dplyr::bind_rows(pub_cal_19, cv_tibble)
vh <- purrr::map(pub_cal_19$link, ~httr::GET(url = .,
httr::accept_json(),
httr::authenticate(username,
password),
config <- httr::config(ssl_verifypeer = FALSE))) %>%
purrr::map(., ~httr::content(.x)) %>%
purrr::compact() %>%
purrr::map(., ~.x$body$storage$value) %>%
purrr::map(., xml2::read_html) %>%
purrr::map(., ~rvest::html_nodes(.x, "table")) %>%
purrr::map(., ~rvest::html_table(.x, fill = TRUE))
vh <- purrr::map(pub_cal_19$link, ~httr::GET(url = .,
httr::accept_json(),
httr::authenticate(Sys.getenv("CONFLUENCE_USERNAME"), Sys.getenv("CONFLUENCE_PASSWORD")),
config <- httr::config(ssl_verifypeer = FALSE))) %>%
purrr::map(., ~httr::content(.x)) %>%
purrr::compact() %>%
purrr::map(., ~.x$body$storage$value) %>%
purrr::map(., xml2::read_html) %>%
purrr::map(., ~rvest::html_nodes(.x, "table")) %>%
purrr::map(., ~rvest::html_table(.x, fill = TRUE))
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history")
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
dplyr::mutate(version_history = rev(as.numeric(version_history)))
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
dplyr::mutate(version_history = rev(as.numeric(version_history)))
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history")
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
dplyr::mutate(versionhistory = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, versionhistory)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history")
View(vh_id)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
select(-12) %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history)
View(vh_id)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
select(-12) %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::left_join(pub_cal_19, vh_id) %>%
dplyr::select(-link) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::mutate(email = as.character(as.list(email)),
name = as.character(as.list(name))) %>%
dplyr::group_by(Title, Program, Status, `Original publication date`, `New publication date`, `Reasons for delay`, Author,  Approver, Type, `Production coordinator`) %>%
dplyr::slice(1) %>%
dplyr::ungroup() %>%
dplyr::filter(Title != "") %>%
janitor::clean_names() %>%
dplyr::mutate(date = as.Date(gsub("T.*", "", date))) %>%
dplyr::group_by(title) %>%
dplyr::arrange(title, date) %>%
dplyr::ungroup()
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
select(-12) %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::left_join(pub_cal_19, vh_id)
View(pub_cal_19)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
select(-12) %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::left_join(pub_cal_19, vh_id, by= "NULL") %>%
dplyr::select(-link) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::mutate(email = as.character(as.list(email)),
name = as.character(as.list(name))) %>%
dplyr::group_by(Title, Program, Status, `Original publication date`, `New publication date`, `Reasons for delay`, Author,  Approver, Type, `Production coordinator`) %>%
dplyr::slice(1) %>%
dplyr::ungroup() %>%
dplyr::filter(Title != "") %>%
janitor::clean_names() %>%
dplyr::mutate(date = as.Date(gsub("T.*", "", date))) %>%
dplyr::group_by(title) %>%
dplyr::arrange(title, date) %>%
dplyr::ungroup()
View(vh_id)
View(pub_cal_19)
vh_id <- vh %>%
purrr::map_dfr(dplyr::bind_rows, .id = "version_history") %>%
select(-12) %>%
dplyr::mutate(version_history = rev(as.numeric(version_history))) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::left_join(pub_cal_19, vh_id, by = "version_history") %>%
dplyr::select(-link) %>%
dplyr::arrange(Title, version_history) %>%
dplyr::mutate(email = as.character(as.list(email)),
name = as.character(as.list(name))) %>%
dplyr::group_by(Title, Program, Status, `Original publication date`, `New publication date`, `Reasons for delay`, Author,  Approver, Type, `Production coordinator`) %>%
dplyr::slice(1) %>%
dplyr::ungroup() %>%
dplyr::filter(Title != "") %>%
janitor::clean_names() %>%
dplyr::mutate(date = as.Date(gsub("T.*", "", date))) %>%
dplyr::group_by(title) %>%
dplyr::arrange(title, date) %>%
dplyr::ungroup()
View(vh_id)
devtools::build()
